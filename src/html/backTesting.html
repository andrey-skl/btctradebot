<html>
<head>
	<title>Backtesting</title>
	<link rel="stylesheet" href="../js/vendor/bootstrap/css/bootstrap.css">

	<link rel="stylesheet" href="../js/vendor/bootstrap/css/bootstrap-theme.css">


	<script src="../js/vendor/jquery-2.0.3.js"></script>
	<script src="../js/vendor/js-TA.js"></script>
	<script src="../js/vendor/underscore.js"></script>
	<script src="../js/vendor/highstock.js"></script>
	<script src="../js/vendor/bootstrap/js/bootstrap.js"></script>
	<script src="../js/vendor/moment-with-langs.js"></script>

	<script src="../js/fakeApi.js"></script>
	<script src="../js/strategyApiCallsHandler.js"></script>
	<script src="../js/tradingSignalProcessor.js"></script>
	<script src="../js/tradeCore.js"></script>
	<script src="../js/logger.js"></script>
	<script src="../js/strategyStorage.js"></script>
	<script src="../js/backTester.js"></script>
	<script src="../js/chartsUi.js"></script>

	<script src="../js/backtestPage/testingControl.js"></script>
	<script src="../js/backtestPage/ui.js"></script>
	<script src="../js/backtestPage/chartPage.js"></script>
<style type="text/css" media="screen">
    #editor { 
        width: 100%;
    }
    #logtext{
    	width: 100%;
    	height: 85%;
    }
    #showHideCharts{
    	position: fixed;
    	top: 5px;
    	right:20px;
    	z-index: 9999;
    }
    .font-size-small {
	  font-size: 0.8em;
	}
</style>

</head>
<body>
	<button type="button" class="btn btn-default btn-xs" id="showHideCharts">
	  <span class="glyphicon glyphicon-plus-sign"></span> <span id="showHideChartsText">Hide charts</span>
	</button>

	<div id="container" style="height: 500px; min-width: 500px;"></div>

<!-- Nav tabs -->
<ul class="nav nav-tabs">
  <li class="active" ><a href="#strategy" data-toggle="tab">Strategy</a></li>
  <li><a href="#controlpanel" data-toggle="tab">Control panel</a></li>
</ul>
	
<!-- Tab panes -->
<div class="tab-content">


  <div class="tab-pane active" id="strategy">

	<!-- Single button -->
	&nbsp;Select strategy: 
	<div class="btn-group">
	  <button type="button" class="btn btn-default dropdown-toggle btn-sm" data-toggle="dropdown">
	    <span id="currentStrategyName" class="iCurrentStrategyName">no one</span> <span class="caret"></span>
	  </button>
	  <ul class="dropdown-menu" role="menu" id="strategylist">
	  </ul>
	</div>

  	<button type="button" class="btn btn-default btn-sm" id="newStrategy">
	  <span class="glyphicon glyphicon-plus-sign"></span> Create new
	</button>
  	<button type="button" class="btn btn-default btn-sm" id="saveStrategy">
	  <span class="glyphicon glyphicon-floppy-save"></span> Save
	</button>
	<button type="button" class="btn btn-default btn-sm" id="removeStrategy">
	  <span class="glyphicon glyphicon-remove-circle"></span> Remove
	</button>

	<div id="editor">Please write your own strategy and save it.
	</div>
  </div>


  <div class="tab-pane" id="controlpanel">
  	<button type="button" class="btn btn-default btn-sm" id="testSelectedStrategy">
	  <span class="glyphicon glyphicon-play"></span> Test strategy "<span class="iCurrentStrategyName"></span>"
	</button>

	<table class="table table-bordered table-condensed table-hover">
        <thead>
          <tr>
            <th width="100px">Date</th>
            <th width="100px">Time</th>
            <th>Message</th>
            <th width="20%">Additional</th>
          </tr>
        </thead>
        <tbody id="logBody" class="font-size-small">
        </tbody>
  	</table>

  </div>


</div>

<div>
	<pre id="ema3-ema10" style="display:none;">
	//EMA3-EMA10 strategy from Huston007
var strategyProcessor = function(api, trader){
		var pauseLength = 5;
		var iterator = pauseLength;
		var isBought = false;
		var summ = 0;
		var lastBuyPrice = 0;
		var lastPrice=null;
		var stopLoss = 10;
		var takeProfit = 40;
		var emaMinGraph = trader.addChart('EMA3');
		var emaMaxGraph = trader.addChart('EMA10');
		
		trader.timeFrame = 60;
		
		this.sell = function(){
            isBought = false;
            iterator=pauseLength;
            trader.sellSignal(lastPrice).then(function(){
                
            });
		}
		
		this.buy = function(){
            isBought = true;
            iterator=pauseLength;
            lastBuyPrice = lastPrice;
            trader.buySignal(lastPrice).then(function(){
                
            });
		}
		
		this.handlePeriod= function(tradeData){
			if (iterator>0)
				iterator--;
			lastPrice = tradeData[tradeData.length-1].close;
			var lastDate = tradeData[tradeData.length-1];
			var closedPrices = [];
			for (var i in tradeData){
				closedPrices.push(tradeData[i].close);
			}
			var minEmaPeriod = 3;
			var maxEmaPeriod = 10;
			var minEmaOffset =0;//maxEmaPeriod-minEmaPeriod;
			var lastEmaLength = 4;
			var ema4 = TA.EMAverage(closedPrices, minEmaPeriod);
			var ema8 = TA.EMAverage(closedPrices, maxEmaPeriod);
			/*var ROC = TA.Roc(closedPrices, 10);*/

			var lastEmas = [];
			/*filling last emas*/	
			for (var i=0; i<lastEmaLength; i++ ){
				lastEmas.push({
					ema4: ema4[ema4.length -minEmaPeriod-minEmaOffset -lastEmaLength+ i+1 ],
					ema8: ema8[ema8.length - maxEmaPeriod -lastEmaLength+ i+1 ]
				});
			}	
			emaMinGraph.push([trader.lastDate.getTime(),lastEmas[lastEmas.length-1].ema4]);
			emaMaxGraph.push([trader.lastDate.getTime(),lastEmas[lastEmas.length-1].ema8]);
			/*searching upper cross*/
			for (var i = 1; i<lastEmas.length; i++){
				var prevEmas = lastEmas[i-1];
				var lastEma = lastEmas[i];
				if (!prevEmas.ema4 || !prevEmas.ema8 || !lastEma.ema4 || !lastEma.ema8)
					continue;
				if (prevEmas.ema4 < prevEmas.ema8 && lastEma.ema4 > lastEma.ema8){
					if (iterator==0 && !isBought) {
						this.buy();
					}
				} else if (prevEmas.ema4 > prevEmas.ema8 && lastEma.ema4 < lastEma.ema8){
					if (iterator==0 && isBought) {
						this.sell();
					}
				}
			}
			
			if (isBought && lastPrice<lastBuyPrice-stopLoss){
				log('stopLoss shouted!!!',trader.lastDate);
				this.sell();
			}
			if (isBought && lastPrice>lastBuyPrice+takeProfit){
				log('takeProfit shouted!!!',trader.lastDate);
				this.sell();
			}
		};	
	};
	</pre>
	<pre id="fourEmas" style="display:none;">
	//four emas strategy from Huston007
	var strategyProcessor = function(api, trader){
		var pauseLength = 8;
		var iterator = pauseLength;
		var isBought = false;
		var summ = 0;
		var lastBuyPrice = 0;
		var lastPrice=null;
		var stopLoss = 4;
		var takeProfit = 40;
		var longPeriod = 34;
		var shortPeriod = 12;
		var emaHighGraph = trader.addChart('EMA long high');
		var emaLowGraph = trader.addChart('EMA long low');
		var emaCloseGraph = trader.addChart('EMA long close');
		var emaFastGraph = trader.addChart('EMA short close');
		
		trader.timeFrame = 3600;
		
		this.sell = function(){

            trader.sellSignal(lastPrice).then(function(){
                isBought = false;
                iterator=pauseLength;
            });
		}
		
		this.buy = function(){

            trader.buySignal(lastPrice).then(function(){
                isBought = true;
                iterator=pauseLength;
                lastBuyPrice = lastPrice;               
            });
		}
		
		this.handlePeriod= function(tradeData){
			if (iterator>0)
				iterator--;
			lastPrice = tradeData[tradeData.length-1].close;
			var lastDate = tradeData[tradeData.length-1];
			var closedPrices = [], lowPrices=[], highPrices=[];
			for (var i in tradeData){
				closedPrices.push(tradeData[i].close);
				lowPrices.push(tradeData[i].low);
				highPrices.push(tradeData[i].high);
			}

			var lastEmaLength = 14;
			var ema34high = TA.EMAverage(highPrices, longPeriod);
			var ema34low = TA.EMAverage(lowPrices, longPeriod);
			var ema34close = TA.EMAverage(closedPrices, longPeriod);
			var ema12close = TA.EMAverage(closedPrices, shortPeriod);

			var lastEmas = [];
			/*filling last emas*/	
			for (var i=0; i<lastEmaLength; i++ ){
				lastEmas.push({
					ema34high: ema34high[ema34high.length -longPeriod -lastEmaLength+ i+1 ],
					ema34low: ema34low[ema34low.length -longPeriod -lastEmaLength+ i+1 ],
					ema34close: ema34close[ema34close.length -longPeriod -lastEmaLength+ i+1 ],
					ema12close: ema12close[ema12close.length -shortPeriod -lastEmaLength+ i+1 ],
				});
			}	
			var dt = trader.lastDate.getTime();
    		
			emaHighGraph.push([dt,lastEmas[lastEmas.length-1].ema34high]);
			emaLowGraph.push([dt,lastEmas[lastEmas.length-1].ema34low]);
			emaCloseGraph.push([dt,lastEmas[lastEmas.length-1].ema34close]);
			emaFastGraph.push([dt,lastEmas[lastEmas.length-1].ema12close]);
			/*searching upper cross*/
			
			var lastVal = lastEmas[lastEmas.length-1]
			
			var isLastPotinInTop = lastVal.ema12close > lastVal.ema34high &&
			    lastVal.ema12close > lastVal.ema34low &&
			    lastVal.ema12close > lastVal.ema34close;
			var isLastPointInBottom = lastVal.ema12close < lastVal.ema34high &&
			    lastVal.ema12close < lastVal.ema34low &&
			    lastVal.ema12close < lastVal.ema34close;
			    
			var hasPointWithLastInTop, hasPointWithLastInBottom;
			_.map(lastEmas, function(val){
			    if (val.ema12close < val.ema34high &&
			    val.ema12close < val.ema34low &&
			    val.ema12close < val.ema34close)
			    {
			        hasPointWithLastInBottom = true;
			    }
			    if (val.ema12close > val.ema34high &&
			    val.ema12close > val.ema34low &&
			    val.ema12close > val.ema34close)
			    {
			        hasPointWithLastInTop = true;
			    }
			});
			     
			if (isLastPotinInTop && hasPointWithLastInBottom){
			    if (iterator==0 && !isBought) {
						this.buy();
					}
			}
			
			if (isLastPointInBottom && hasPointWithLastInTop){
			    if (iterator==0 && isBought) {
						this.sell();
					}
			}

			if (isBought && lastPrice<lastBuyPrice-stopLoss){
				log('stopLoss shouted!!!',trader.lastDate);
				this.sell();
			}
			if (isBought && lastPrice>lastBuyPrice+takeProfit){
				log('takeProfit shouted!!!',trader.lastDate);
				this.sell();
			}
		};	
	};
	</pre>
	<pre id="stohastic" style="display:none;">
//Stochastic strategy from Huston007
var strategyProcessor = function(api, trader){
        var STOHASTIC_PERIOD = 20;
		var pauseLength = 5;
		var iterator = pauseLength;
		var isBought = false;
		var lastBuyPrice = 0;
		var lastPrice=null;
		var stopLoss = 4;
		var takeProfit = 10;
		var stohastic = trader.addChart('Stohastic', "bottom");
		
		var calcStohastic = function(data, period){
		    var len = data.length;
		    if (len<period)
		    {
		        return null;
		    }
		    var Ct = data[len-1].close;
		    var minArray = data.slice(len-period).map(function(item){
		        return item.low;
		    });
		    var maxArray = data.slice(len-period).map(function(item){
		        return item.high;
		    });
		    var Ln = _.min(minArray);
		    var Hn = _.max(maxArray);
		    return (Ct-Ln)/(Hn-Ln)*100;
		}
		
		trader.timeFrame = 60;
		
		this.sell = function(){
            trader.sellSignal(lastPrice).then(function(){
                isBought = false;
                iterator=pauseLength;
            });
		}
		
		this.buy = function(){
            trader.buySignal(lastPrice).then(function(){
                isBought = true;
                iterator=pauseLength;
                lastBuyPrice = lastPrice;               
            });
		}
		
		this.handlePeriod= function(tradeData){
			if (iterator>0)
				iterator--;
			lastPrice = tradeData[tradeData.length-1].close;
			var lastDate = tradeData[tradeData.length-1];
			
			var prevSt = calcStohastic(tradeData.slice(0,tradeData.length-1), STOHASTIC_PERIOD);
			var st = calcStohastic(tradeData, STOHASTIC_PERIOD);
			
			stohastic.push([trader.lastDate.getTime(), st]);
			
			if (!isBought && prevSt<20 && st > 20){
			    this.buy();
			}
			if (isBought && prevSt>80 && st < 80){
			    this.sell();
			}
			
			if (isBought && lastPrice<lastBuyPrice-stopLoss){
				log('stopLoss shouted!!!',trader.lastDate);
				this.sell();
			}
			if (isBought && lastPrice>lastBuyPrice+takeProfit){
				log('takeProfit shouted!!!',trader.lastDate);
				this.sell();
			}
		};	
	};
	</pre>
</div>

	<script src="../js/vendor/ace/ace.js" type="text/javascript" charset="utf-8"></script>
</body>