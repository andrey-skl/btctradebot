<html>
<head>
	<title>Backtesting</title>
	<link rel="stylesheet" href="../js/vendor/bootstrap/css/bootstrap.css">

	<link rel="stylesheet" href="../js/vendor/bootstrap/css/bootstrap-theme.css">


	<script src="../js/vendor/jquery-2.0.3.js"></script>
	<script src="../js/vendor/js-TA.js"></script>
	<script src="../js/vendor/underscore.js"></script>
	<script src="../js/vendor/highstock.js"></script>
	<script src="../js/vendor/bootstrap/js/bootstrap.js"></script>
	<script src="../js/vendor/moment-with-langs.js"></script>

	<script src="../js/fakeApi.js"></script>
	<script src="../js/strategyApiCallsHandler.js"></script>
	<script src="../js/tradingSignalProcessor.js"></script>
	<script src="../js/tradeCore.js"></script>
	<script src="../js/logger.js"></script>
	<script src="../js/strategyStorage.js"></script>
	<script src="../js/backTester.js"></script>
	<script src="../js/chartsUi.js"></script>

	<script src="../js/backtestPage/testingControl.js"></script>
	<script src="../js/backtestPage/ui.js"></script>
	<script src="../js/backtestPage/chartPage.js"></script>
<style type="text/css" media="screen">
    #editor { 
        width: 100%;
    }
    #logtext{
    	width: 100%;
    	height: 85%;
    }
    #showHideCharts{
    	position: fixed;
    	top: 5px;
    	right:20px;
    	z-index: 9999;
    }
    .font-size-small {
	  font-size: 0.8em;
	}
</style>

</head>
<body>
	<button type="button" class="btn btn-default btn-xs" id="showHideCharts">
	  <span class="glyphicon glyphicon-plus-sign"></span> <span id="showHideChartsText">Hide charts</span>
	</button>

	<div id="container" style="height: 500px; min-width: 500px;"></div>

<!-- Nav tabs -->
<ul class="nav nav-tabs">
  <li class="active" ><a href="#strategy" data-toggle="tab">Strategy</a></li>
  <li><a href="#controlpanel" data-toggle="tab">Control panel</a></li>
</ul>
	
<!-- Tab panes -->
<div class="tab-content">


  <div class="tab-pane active" id="strategy">

	<!-- Single button -->
	&nbsp;Select strategy: 
	<div class="btn-group">
	  <button type="button" class="btn btn-default dropdown-toggle btn-sm" data-toggle="dropdown">
	    <span id="currentStrategyName" class="iCurrentStrategyName">no one</span> <span class="caret"></span>
	  </button>
	  <ul class="dropdown-menu" role="menu" id="strategylist">
	  </ul>
	</div>

  	<button type="button" class="btn btn-default btn-sm" id="newStrategy">
	  <span class="glyphicon glyphicon-plus-sign"></span> Create new
	</button>
  	<button type="button" class="btn btn-default btn-sm" id="saveStrategy">
	  <span class="glyphicon glyphicon-floppy-save"></span> Save
	</button>
	<button type="button" class="btn btn-default btn-sm" id="removeStrategy">
	  <span class="glyphicon glyphicon-remove-circle"></span> Remove
	</button>

	<div id="editor">Please write your own strategy and save it.
	</div>
  </div>


  <div class="tab-pane" id="controlpanel">
  	<button type="button" class="btn btn-default btn-sm" id="testSelectedStrategy">
	  <span class="glyphicon glyphicon-play"></span> Test strategy "<span class="iCurrentStrategyName"></span>"
	</button>

	<table class="table table-bordered table-condensed table-hover">
        <thead>
          <tr>
            <th width="100px">Date</th>
            <th width="100px">Time</th>
            <th>Message</th>
            <th width="20%">Additional</th>
          </tr>
        </thead>
        <tbody id="logBody" class="font-size-small">
        </tbody>
  	</table>

  </div>


</div>

<div>
	<pre id="defaultStrategy" style="display:none;">
var strategyProcessor = function(api, trader){
		var pauseLength = 5;
		var iterator = pauseLength;
		var isBought = false;
		var summ = 0;
		var lastBuyPrice = 0;
		var lastPrice=null;
		var stopLoss = 10;
		var takeProfit = 40;
		var emaMinGraph = trader.addChart('EMA3');
		var emaMaxGraph = trader.addChart('EMA10');
		
		trader.timeFrame = 60;
		
		this.sell = function(){
            isBought = false;
            iterator=pauseLength;
            trader.sellSignal(lastPrice).then(function(){
                
            });
		}
		
		this.buy = function(){
            isBought = true;
            iterator=pauseLength;
            lastBuyPrice = lastPrice;
            trader.buySignal(lastPrice).then(function(){
                
            });
		}
		
		this.handlePeriod= function(tradeData){
			if (iterator>0)
				iterator--;
			lastPrice = tradeData[tradeData.length-1].close;
			var lastDate = tradeData[tradeData.length-1];
			var closedPrices = [];
			for (var i in tradeData){
				closedPrices.push(tradeData[i].close);
			}
			var minEmaPeriod = 3;
			var maxEmaPeriod = 10;
			var minEmaOffset =0;//maxEmaPeriod-minEmaPeriod;
			var lastEmaLength = 4;
			var ema4 = TA.EMAverage(closedPrices, minEmaPeriod);
			var ema8 = TA.EMAverage(closedPrices, maxEmaPeriod);
			/*var ROC = TA.Roc(closedPrices, 10);*/

			var lastEmas = [];
			/*filling last emas*/	
			for (var i=0; i<lastEmaLength; i++ ){
				lastEmas.push({
					ema4: ema4[ema4.length -minEmaPeriod-minEmaOffset -lastEmaLength+ i+1 ],
					ema8: ema8[ema8.length - maxEmaPeriod -lastEmaLength+ i+1 ]
				});
			}	
			emaMinGraph.push([trader.lastDate.getTime(),lastEmas[lastEmas.length-1].ema4]);
			emaMaxGraph.push([trader.lastDate.getTime(),lastEmas[lastEmas.length-1].ema8]);
			/*searching upper cross*/
			for (var i = 1; i<lastEmas.length; i++){
				var prevEmas = lastEmas[i-1];
				var lastEma = lastEmas[i];
				if (!prevEmas.ema4 || !prevEmas.ema8 || !lastEma.ema4 || !lastEma.ema8)
					continue;
				if (prevEmas.ema4 < prevEmas.ema8 && lastEma.ema4 > lastEma.ema8){
					if (iterator==0 && !isBought) {
						this.buy();
					}
				} else if (prevEmas.ema4 > prevEmas.ema8 && lastEma.ema4 < lastEma.ema8){
					if (iterator==0 && isBought) {
						this.sell();
					}
				}
			}
			
			if (isBought && lastPrice<lastBuyPrice-stopLoss){
				log('stopLoss shouted!!!',trader.lastDate);
				this.sell();
			}
			if (isBought && lastPrice>lastBuyPrice+takeProfit){
				log('takeProfit shouted!!!',trader.lastDate);
				this.sell();
			}
		};	
	};
	</pre>
</div>

	<script src="../js/vendor/ace/ace.js" type="text/javascript" charset="utf-8"></script>
</body>